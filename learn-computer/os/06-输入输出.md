

分类
- 按使用特性分类
	- 人机交互的外部设备、存储设备、网络通信设备
- 按传输速率分类
	- 低速设备、中速设备、高速设备
- 按信息交换的单位分类
	- 块设备、字符设备


基本功能
- 隐藏物理设备细节
- 设备无关性：使用抽象的设备名 `/dev/printer`
- 提高处理机和IO设备的利用率
- 对IO设备进行控制
- 对设备进行正确的共享
- 设备的错误处理



**I-O软件层次结构**
1、用户层软件
- 实现与用户交互的接口，向上提供方便易用的库函数
- 假脱机系统 SPOOLing
2、设备独立性软件（设备无关性软件）
- 向上层提供统一的调用接口（read/write）
- 设备的保护
- 差错处理
- 设备的分配与回收
- 数据缓冲区管理
- 建立逻辑设备名到物理设备名的映射关系
- 根据设备类型选择调用相应的驱动程序
3、设备驱动程序（比如打印机驱动）
- 设置设备寄存器、检查设备状态
4、中断处理程序
5、硬件
- 执行IO操作，由机械部件、电子部件组成

>2、3、4属于内核部分，又名 I-O核心子系统；在408中，假脱机系统 SPOOLing也归于


IO API
- 字符设备 I/O-stream
- 块设备 read/write
- 网络设备
	- 又称“网络套接字(socket)接口”socket 系统调用:创建一个网络套接字，需指明网络协议(TCP?UDP?)
	- bind:将套接字绑定到某个本地“端口
	- connect:将套接字连接到远程地址
	- read/write:从套接字读/写数据









### IO控制器

【ゆCPU接口->IO逻辑->ゆ设备接口】
- ゆCPU接口
	- DR 数据交换
	- CR 接受和识别CPU发出的命令
	- SR 向CPU报告设备的状态
	- 地址识别


### 控制方式

内存映射IO
- ARM+x86Video
寄存器独立编址
- x86

>ゆ微机原理重叠

控制方式按CPU干预从高到低：
1、程序直接控制方式（轮询）
- 实现简单
- CPU利用率低
2、中断驱动方式
- 大量中断会使cpu效率低
- cpu和io可并行工作
3、DMA方式：直接存储器存取
- 数据单位：连续的多个块。CPU每发出一条IO指令，只能读/写一个或多个连续的数据块。如果要读/写多个离散存储的数据块，或者要将数据分别写到不同的内存区域时，CPU要分别发出多条I0指令，进行多次中断处理才能完成，
- 减少了cpu干预
- DR：数据寄存器；MAR：内存地址寄存器；DC：剩余读写字节数；CR：命令/状态寄存器
4、通道控制方式
- 数据单位：任务清单。通道可以识别并执行一系列通道指令。cpu发送命令给通道，然后让通道处理IO操作就行了。处理完了，向cpu发送中断信号。

### 假脱机技术

SPOOLing系统：必须要有多道程序并发进行

Tips:为什么称为“脱机”--脱离主机的控制进行的输入/输出操作。

假脱机是软件模拟


2、假脱机技术的实现原理

模拟一个中转外部设备

- 输入井和输出井
- 输入进程和输出进程
- 输入缓冲区和输出缓冲区

应用
- 共享打印机

守护进程(daemon) 是中转站，唯一一个使用对应硬件的进程，其他应用将要发送或接收的数据上报给守护进程。

### 缓冲区



一个存储区域

作用
- 缓和CPU与IO设备之间速度不匹配的矛盾
- 减少对CPU的中断频率
- 解决数据粒度不匹配的问题
- 提高CPU与IO设备之间的并行性

#### 单缓冲

在内存中分配一块缓冲区
满后才可以传出，满后不可以写入
输入缓冲区时间T 缓冲区到用户工作区传送M 处理C
处理一块时间=max(C,T)+M

#### 双缓冲

在内存中分配两块缓冲区

max(T,C+M)

#### 循环缓冲

有 in, out 指针

#### 缓冲池

由系统中共用的缓冲区组成。这些缓冲区可以分为：
- 空缓冲队列、
- 装满输入数据的缓冲队列、
- 装满输出数据的缓冲队列

另外，根据一个缓冲区在实际运算中扮演的功能不同，又设置了四种工作缓冲区:用于收容输入数据的工作缓冲区(hin)、用于提取输入数据的工作缓冲区(sin)、用于收容输出数据的工作缓冲区(hout)、用于提取输出数据的工作缓冲区(sout)

“收容”将空缓冲队列某个缓冲区填充满后，挂载输入或输出队列尾部

### 设备的分配与回收


1、设备分配时应考虑的因素

设备的固有属性：独占设备(打印机、LCD1602-IIC的功能实现的各个单条通信)、共享设备(磁盘)、虚拟设备（共享打印机）

设备分配算法：

设备分配中的安全：为进程分配一个设备后就将进程阻塞，本次IO完成后才将进程唤醒

2、静态分配与动态分配

静态分配：进程运行前为其分配全部所需资源、运行结束后归还资源

动态分配：运行中动态分配

3、设备分配管理中的数据结构

树
- 通道
	- 控制器
		- 设备

设备控制表DCT（设备类型、设备标识符、设备状态、指向控制器表的指针、重复执行次数或事件、设备队列的队首指针）

系统设备表SDT，表目：（设备类型、设备标识符、DCT、驱动程序入口）

控制器控制表COCT（控制器标识符、控制器状态、指向通道表的指针设备队列的队首指针、控制器队列的队尾指针）

通道控制表CHCT（通道标识符、通道状态、与通道连接的控制器表首址、通道队列的队首指针、通道队列的队尾指针）

4、设备分配的步骤

根据进程请求的物理设备名SDT——>设备控制表DCT(设备忙碌就挂到设备等待队列)
——>控制器控制表COCT(控制器等待队列)
——>通道CHCT(通道等待队列)

缺点:
1用户编程时必须使用“物理设备名”，底层细节对用户不透明，不方便编程
②若换了一个物理设备，则程序无法运行
③若进程请求的物理设备正在忙碌，则即使系统中还有同类型的设备，进程也必须阻塞等待

5、设备分配步骤的改进方法

1 操作系统建立逻辑设备名（例如 /dev/sda ）和设备的映射，程序使用逻辑设备名

2 逻辑设备名设置问题
- 整个系统只有一张LUT:各用户所用的逻辑设备名不允许重复
- 每个用户一张LUT:各个用户的逻辑设备名可重复


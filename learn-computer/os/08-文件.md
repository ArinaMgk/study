

>大概是一个表格类型的文件格式
- 数据项
- 记录：一组相关数据项的集合
	- 关键字(key)是唯一能标识一个记录的数据项
- 文件：记录项的集合

FS的层次结构
- 用户(程序) 》文件系统接口》对对象操纵和管理的软件集合》对象及其属性

基本功能/操作：
- create
	- 在外存中找到文件所需的空间
	- 创建该文件对应的目录项
- delete
	- 找到文件名对应的目录项
	- 回收文件占用的磁盘块
	- 删除文件对应的目录项
- read
- write
- open
	- 找到文件名对应的目录项。将目录项中的信息复制到内存中的打开文件表中，并将打开文件表的索引号返回给用户。打开文件时并不会把文件数据直接读入内存。“索引号”也称“文件描述符
- fseek
- close
高级功能/操作：
- 文件共享
	- 基于索引结点的共享方式（硬链接）
		- 直接指向文件的索引节点
	- 基于符号链的共享方式（软链接）
		- 一个文件，但是对该文件的操作会被重定向到另一个文件中
		- 相当于win的快捷方式 `ln -s ...`
- 文件保护
	- 1、口令保护
		- 口令一般存放在文件对应的 FCB 或索引结点中。用户访问文件前需要先输入“口令”，操作系统会将用户提供的口令与FCB中存储的口令进行对比，如果正确，则允许该用户访问文件
		- 开销小 不够安全
	- 2、加密保护
		- 磁盘中保存的是密文
		- そ：保密性强，不需要在系统中存储“密码”
		- き：编码/译码，需要花费一定时间
	- 3、访问控制
		- 在每个文件的FCB中增加一个访问控制表（ACL），该表记录了各个用户可以对该文件执行哪些操作。精简的访问列表:以“组”为单位，标记各“组”用户可以对文件执行哪些操作。
		- 如:分为系统管理员、文件主、文件主的伙伴、其他用户几个分组。当某用户想要访问文件时，系统会检查该用户所属的分组是否有相应的访问权限。
		- 实现灵活，可以实现复杂的文件保护功能

打开文件表
- 位于系统
	- 方便检查互斥，有被指向的计数器
- 位于应用
	- 每一项指向系统表对应的项

文件系统的层次结构
- 用户接口——系统调用
	- 文件目录系统——根据用户给出的文件路径找到相应的FCB或索引结点。所有和目录、目录项相关的管理工作都在本层完成，如:管理活跃的文件目录表、管理打开文件表等
		- 存取控制模块——权限验证
			- 逻辑文件系统与文件信息缓冲区——用户指明想要访问文件记录号，这一层需要将记录号转换为对应的逻辑地址
				- 物理文件系统——转物理地址
					- 辅助分配模块——分配和回收算法
					- 设备管理模块
						- 设备



### File Logical Structure / File Organization

用户视角

>可以用C语言各举个例子

- 无结构文件
	- 文件由一系列二进制文件流组成
- 有结构文件（记录式文件）
	- 顺序文件：文件中的记录一个接一个顺序排列，定长或变长，可以顺序存储或者链式存储
		- 按照是否与关键字顺序有关，可以分为串结构和顺序结构
		- 物理链式存储：无法随机存取
		- 物理顺序存储：
			- 可变长：无法随机存取
			- 定长：可以随机存取
				- 采用串结构，无法快速找到关键字
				- 采用顺序结构，可以快速查找关键字
	- 索引文件：索引(key)表本身是定长的顺序文件。将【键，长度，内容】变为定长的【键，长度，指针】
	- 索引顺序文件：多级索引表嵌套查找
		- 索引顺序文件是索引文件和顺序文件思想的结合。索引顺序文件中，同样会为文件建立张索引表，但不同的是:并不是每个记录对应一个索引表项，而是一组记录对应一个索引表项。
		- 索引顺序文件的索引项也不需要按关键字顺序排列，这样可以极大地方便新表项的插入
		- 二级索引顺序文件：【键，地址】→【键，地址】→【关键字，其他】


### Phyzik Structure

1、对非空闲磁盘块的管理

1.1 连续分配：连续分配方式要求每个文件在磁盘上占有一组连续的块

对磁头友好

对文件的拓展不方便，有很多磁盘碎片

1.1 链接分配

- 隐式分配（默认）
	- 【文件名，起始块号，结束块号】
	- 除文件的最后一个盘块之外，每个盘块中都存有指向下一个盘块的指针。
	- 方便拓展；无碎片，利用率高
	- 只支持顺序访问，不支持随机访问
- 显示分配：
	- 文件分配表显式记录下一块物理块的位置，
	- 方便拓展，支持随机访问
	- 文件表会占内存空间
	- 把用于链接文件各物理块的指针显式地存放在一张表中。即 文件分配衣(FAT, File Allocation Table )
	- 【块号，下一个块号】

1.1 索引分配

- 索引分配允许文件离散地分配在各个磁盘块中，系统会为每个文件建立一张索引表，索引表记录了文件的各个逻辑块对应的物理块
- 支持随机访问
- 逻辑层【文件名，索引块】
- 物理层 索引块【一系列 物理块号 按 】×n
- 多索引表排布策略
	- 链接方案
		- 将多个索引块链接起来存放
	- 多层索引
		- 第一层索引块指向第二层的索引块……
		- 固定层级
	- 混合索引

### 文件存储空间管理

1、存储空间的划分与初始化

- 文件卷（逻辑卷） 分卷、分区
- 目录区与文件区

有的系统支持多个磁盘组成一个分区

2、几种管理方法

- 空闲表法：首位置+长度，回收时注意修改
	- 【第一个空闲盘块号， 空闲盘块数】
	- 与内存管理中的动态分区分配很类似，为一个文件分配连续的存储空间。同样可采用首次适应、最佳适应、最坏适应等算法来决定要为文件分配哪个区间。
- 空闲链表法
	- 空闲盘块链
	- 空闲盘区链（连续的盘块）
- 位示图法
	- 位图表示是否已使用
	- (字号,位号)=(i,j)的二进制位对应的盘块号b=ni+j
- 成组链接法
	- Linux使用
	- 文件卷的目录区中专门用一个磁盘块作为超级块，当系统启动时需要将超级内存块读入内存。并且保证内存与外存中的超级块数据一致。
	- 超级块：记录 本分组空闲盘数+p_下一组+一系列空闲盘起始号

### 文件目录

1、文件控制块（FCB）

搜索、创建文件、删除文件、显示目录、修改目录

目录文件中的一条记录就是一个“文件控制块(FCB)

2、目录结构

- 单级目录结构
- 两级目录结构
	- 主文件目录（MFD）+用户文件目录（UFD）
- 多级目录结构（树形目录结构）
	- 当代操作系统采用方法、不便于文件共享
- 无环图目录结构
	- 可以共享
	- 在树形目录结构的基础上，增加一些指向同一节点的有向边，使整个目录成为一个有向无环图，可以更方便地实现多个用户间的文件共享。
	- 每个文件有被指向(共享)计数器

3、索引节点（对文件控制块的改进）

由【文件名，权限，物理位置，……】→【文件名，索引节点指针】

压缩文件名和信息

可以提升检索速度

### 格式化

物理格式化，即低级格式化--划分扇区，检测坏扇区，并用备用扇区替换坏扇区，对OS透明

逻辑格式化后，磁盘分区(分卷Volume)，完成各分区的文件系统初始化

近期访问过的目录文件会缓存在内存中，不用每次都从磁盘读入，这样可以加快目录检索速度

### 虚拟文件系统、文件系统挂载

对文件系统引入统一接口

vnode 对不同 FS 目录项策略以及数据的统一接口

文件系统挂载要做的事:
①在VFS中注册新挂载的文件系统内存中的挂载表(mounttable)包含每个文件系统的相关信息，包括文件系统类型、容量大小等。
②新挂载的文件系统，要向VFS提供一个函数地址列表
③将新文件系统加到挂载点(mountpoint)，也就是将新文件系统挂载在某个父目录下









